export interface FiqhEntry {
    id: string;
    keywords: string[];
    question: string;
    answer: {
        intro: string;
        sunniView: string; // للمذاهب الأربعة
        shiaView: string; // للمذهب الجعفري
        summary: string;
    };
    sources: string[]; // قائمة المراجع
}

export const fiqhDatabase: FiqhEntry[] = [
    {
        id: 'combine_prayers',
        keywords: ['جمع', 'صلوات', 'صلاة', 'ظهر', 'عصر', 'مغرب', 'عشاء', 'تقديم', 'تأخير'],
        question: "ما حكم الجمع بين الصلوات (الظهر والعصر / المغرب والعشاء)؟",
        answer: {
            intro: "أصل المسألة وارد في القرآن الكريم في قوله تعالى: (إِنَّ الصَّلَاةَ كَانَتْ عَلَى الْمُؤْمِنِينَ كِتَابًا مَوْقُوتًا)، وقد وردت أحاديث عن النبي ﷺ في الجمع.",
            sunniView: "**عند أهل السنة والجماعة:**\n- الأصل هو أداء كل صلاة في وقتها.\n- **الحنفية:** لا يجوز الجمع إلا في عرفة ومزدلفة (جمع مناسك).\n- **الجمهور (المالكية والشافعية والحنابلة):** يجوز الجمع لعذر (سفر، مطر، مرض، خوف).\n- أجاز بعض الحنابلة الجمع للحاجة الشديدة بشرط ألا يتخذ عادة.",
            shiaView: "**عند الشيعة الإمامية (الجعفرية):**\n- يجوز الجمع بين الظهر والعصر، وبين المغرب والعشاء في الحضر والسفر دون عذر، وإن كان التفريق أفضل (مستحب).\n- يستندون لروايات أن النبي ﷺ جمع من غير خوف ولا مطر توسعةً لأمته.",
            summary: "يتفق الجميع على جواز الجمع بعذر (كالسفر وعرفة)، ويختلفون في الجمع بدون عذر؛ حيث يمنعه جمهور السنة إلا لضرورة قصوى، ويجيزه الشيعة مطلقاً مع استحباب التفريق."
        },
        sources: [
            "صحيح مسلم: كتاب صلاة المسافرين (حديث ابن عباس)",
            "المغني لابن قدامة (فقه حنبلي)",
            "بداية المجتهد لابن رشد (فقه مقارن)",
            "وسائل الشيعة: أبواب المواقيت (للحر العاملي)",
            "الاستبصار للشيخ الطوسي"
        ]
    },
    {
        id: 'zakat_fitr',
        keywords: ['زكاة', 'فطر', 'رمضان', 'عيد', 'مال', 'طعام', 'قيمة', 'نقود'],
        question: "هل يجوز إخراج زكاة الفطر نقداً (مالاً) أم يجب طعاماً؟",
        answer: {
            intro: "زكاة الفطر فريضة طهرة للصائم وطعمة للمساكين. الأصل فيها إخراج الصاع من قوت البلد.",
            sunniView: "**عند أهل السنة:**\n- **الجمهور (المالكية والشافعية والحنابلة):** يجب إخراجها طعاماً (تمر، شعير، أرز..) ولا يجزئ المال إلا لضرورة عند البعض.\n- **الحنفية:** يجوز إخراج القيمة (المال) وهو الأفضل عندهم إذا كان أنفع للفقير.",
            shiaView: "**عند الشيعة الإمامية:**\n- الأصل هو الطعام (الحنطة، الشعير، التمر..).\n- يجوز دفع القيمة (النقود) بدلاً من الطعام، والعبرة بقيمة قوت البلد الغالب وقت الإخراج.",
            summary: "المسألة خلافية؛ الجمهور يوجبون الطعام، والحنفية والشيعة وكثير من المعاصرين يجيزون المال إذا كان أنفع للفقير."
        },
        sources: [
            "صحيح البخاري: كتاب الزكاة",
            "الهداية شرح البداية (فقه حنفي)",
            "المجموع شرح المهذب (فقه شافعي)",
            "منهاج الصالحين (للسيد السيستاني)",
            "شرائع الإسلام (للمحقق الحلي)"
        ]
    },
    {
        id: 'wudu_touch',
        keywords: ['وضوء', 'لمس', 'امرأة', 'زوجة', 'نقض', 'نساء'],
        question: "هل لمس المرأة ينقض الوضوء؟",
        answer: {
            intro: "اختلف العلماء في تفسير قوله تعالى: (أَوْ لَامَسْتُمُ النِّسَاءَ).",
            sunniView: "**عند أهل السنة:**\n- **الشافعية:** اللمس ينقض مطلقاً (بشهوة أو بدونها) إذا كان بلا حائل.\n- **المالكية والحنابلة:** ينقض إذا كان بشهوة.\n- **الحنفية:** لا ينقض اللمس مطلقاً إلا إذا حدث خروج مذي أو مني (الجماع).",
            shiaView: "**عند الشيعة الإمامية:**\n- لمس المرأة لا ينقض الوضوء مطلقاً، سواء كان بشهوة أو بدونها، والمقصود بالآية هو الجماع.",
            summary: "الخلاف واسع؛ الأحوط عند الشك الوضوء خروجاً من الخلاف (رأي الشافعية)، والأيسر رأي الحنفية والشيعة بعدم النقض."
        },
        sources: [
            "تفسير الطبري (جامع البيان)",
            "الأم للشافعي",
            "حاشية ابن عابدين (فقه حنفي)",
            "العروة الوثقى (للسيد اليزدي)",
            "الكافي (للكليني)"
        ]
    },
     {
        id: 'fasting_travel',
        keywords: ['صيام', 'سفر', 'مسافر', 'إفطار', 'قصر'],
        question: "ما حكم الصيام في السفر؟",
        answer: {
            intro: "قال تعالى: (فَمَن كَانَ مِنكُم مَّرِيضًا أَوْ عَلَىٰ سَفَرٍ فَعِدَّةٌ مِّنْ أَيَّامٍ أُخَرَ).",
            sunniView: "**عند أهل السنة:**\n- يجوز للمسافر الفطر وعليه القضاء، ويجوز له الصوم.\n- اختلفوا في الأفضل: الجمهور يفضلون الصوم إن لم يشق عليه، وبعضهم يفضل الفطر أخذاً بالرخصة.",
            shiaView: "**عند الشيعة الإمامية:**\n- يجب على المسافر الذي يقصر في صلاته أن يفطر في رمضان، ولا يصح صومه (إلا في حالات نادرة كالنذر).\n- إذا صام في السفر بطل صومه ووجب عليه القضاء.",
            summary: "السنة يرون التخيير مع تفضيل الصوم للقادر، والشيعة يرون وجوب الإفطار للمسافر الذي تنطبق عليه شروط القصر."
        },
        sources: [
            "صحيح مسلم: كتاب الصيام",
            "نيل الأوطار للشوكاني",
            "اللمعة الدمشقية (فقه إمامي)",
            "جواهر الكلام (للشيخ الجواهري)"
        ]
    },
    {
        id: 'riba_interest',
        keywords: ['ربا', 'فوائد', 'بنك', 'قرض', 'فائدة', 'بنوك'],
        question: "ما حكم فوائد البنوك والقروض؟",
        answer: {
            intro: "الربا محرم تحريماً قطعياً في القرآن: (وَأَحَلَّ اللَّهُ الْبَيْعَ وَحَرَّمَ الرِّبَا).",
            sunniView: "**عند أهل السنة:**\n- الفوائد الربوية المشتراطة على القروض محرمة بإجماع المجامع الفقهية.\n- المعاملات البنكية الإسلامية (المرابحة، التورق) جائزة بضوابطها الشرعية.",
            shiaView: "**عند الشيعة الإمامية:**\n- الربا محرم بين المسلمين.\n- يجيز البعض أخذ الفائدة من البنوك غير الإسلامية (الحكومية أو الأجنبية) بنية 'مجهول المالك' وبإذن الحاكم الشرعي.",
            summary: "الربا الصريح محرم عند الجميع. الخلاف يكمن في توصيف بعض المعاملات البنكية المعاصرة والتعامل مع البنوك غير الأهلية."
        },
        sources: [
            "قرارات مجمع الفقه الإسلامي",
            "المجموع للنووي",
            "منهاج الصالحين (الخوئي/السيستاني)",
            "تحرير الوسيلة (للخميني)"
        ]
    },
    {
        id: 'music_songs',
        keywords: ['موسيقى', 'غناء', 'أغاني', 'معازف', 'أناشيد'],
        question: "ما حكم الموسيقى والغناء؟",
        answer: {
            intro: "مسألة المعازف من المسائل التي كثر فيها الجدل قديماً وحديثاً.",
            sunniView: "**عند أهل السنة:**\n- **المذاهب الأربعة:** تحرم المعازف (آلات اللهو) وتستثني الدف في الأعراس والأعياد.\n- **ابن حزم وبعض المعاصرين:** يرون جواز الموسيقى الهادفة التي لا تصاحبها منكرات، ويضعفون أحاديث التحريم.",
            shiaView: "**عند الشيعة الإمامية:**\n- الغناء (الترجيع المطرب المناسب لمجالس اللهو والفسق) محرم.\n- الموسيقى تنقسم إلى: محللة (كالموسيقى الكلاسيكية أو الحماسية) ومحرمة (المناسبة لمجالس الطرب والرقص).",
            summary: "الاتجاه العام في الفقه التقليدي هو التحريم أو الكراهة الشديدة، بينما يميل بعض المعاصرين والشيعة إلى التفصيل بين النوع المحلل (الهادف) والمحرم (الماجن)."
        },
        sources: [
            "إغاثة اللهفان لابن القيم",
            "المحلى لابن حزم",
            "المكاسب المحرمة (للشيخ الأنصاري)",
            "أجوبة الاستفتاءات (للسيد القائد)"
        ]
    },
     {
        id: 'hijab_covering',
        keywords: ['حجاب', 'نقاب', 'وجه', 'كفين', 'ستر', 'تغطية'],
        question: "ما حدود حجاب المرأة (هل الوجه عورة)؟",
        answer: {
            intro: "الحجاب واجب بالكتاب والسنة، واختلفوا في حدود ما يجوز كشفه.",
            sunniView: "**عند أهل السنة:**\n- **الجمهور (مالكية، شافعية، حنفية):** الوجه والكفان ليسا عورة، ويجوز كشفهما مع أمن الفتنة (وإن كان الستر أفضل عند البعض).\n- **الحنابلة:** الوجه عورة ويجب تغطيته (النقاب).",
            shiaView: "**عند الشيعة الإمامية:**\n- المشهور هو جواز كشف الوجه والكفين (بدون زينة ومكياج) مع وجوب ستر باقي الجسد ومفاتنه.",
            summary: "الجميع متفقون على وجوب ستر الجسد والشعر. الخلاف محصور في الوجه والكفين؛ بين الوجوب (الحنابلة) والجواز (الجمهور والشيعة)."
        },
        sources: [
            "تفسير القرطبي",
            "المجموع للشافعي",
            "المغني لابن قدامة",
            "العروة الوثقى",
            "مسائل المنتخبة"
        ]
    }
];

export function searchFiqhDatabase(query: string): FiqhEntry | null {
    const normalize = (text: string) => text.replace(/[^\u0621-\u064A\s]/g, '').toLowerCase();
    const queryTerms = normalize(query).split(/\s+/).filter(w => w.length > 2);
    
    let bestMatch: FiqhEntry | null = null;
    let maxScore = 0;

    for (const entry of fiqhDatabase) {
        let score = 0;
        for (const term of queryTerms) {
            if (entry.keywords.some(k => normalize(k).includes(term))) {
                score++;
            }
        }
        
        // Bonus points if keywords appear in question (more weight)
        if (normalize(entry.question).includes(normalize(query))) {
            score += 2;
        }

        if (score > maxScore) {
            maxScore = score;
            bestMatch = entry;
        }
    }

    // Threshold: needs at least 1 matching keyword to be considered relevant (Lowered from 2)
    return maxScore >= 1 ? bestMatch : null;
}